name: Deploy to Mainnet

on:
  workflow_dispatch:
    inputs:
      network:
        description: 'Target mainnet'
        required: true
        type: choice
        options:
          - mainnet
          - polygon
          - arbitrum
          - optimism
      confirmation:
        description: 'Type "DEPLOY-MAINNET" to confirm'
        required: true
        type: string

env:
  PYTHON_VERSION: "3.11"

jobs:
  validate-confirmation:
    name: Validate Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: inputs.confirmation != 'DEPLOY-MAINNET'
        run: |
          echo "::error::Confirmation failed. You must type 'DEPLOY-MAINNET' to proceed."
          exit 1

      - name: Confirmation accepted
        run: echo "Confirmation accepted. Proceeding with mainnet deployment to ${{ inputs.network }}."

  security-check:
    name: Security Verification
    needs: validate-confirmation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --all-extras

      - name: Run full test suite
        run: uv run pytest tests/ -v

      - name: Security scan with bandit
        run: uv run bandit -r scripts/ -ll

      - name: Verify contract compiles
        run: uv run python -c "import vyper; vyper.compile_code(open('contracts/TesseractBuffer.vy').read())"

  approval:
    name: Manual Approval Required
    needs: security-check
    runs-on: ubuntu-latest
    environment: mainnet-approval
    steps:
      - name: Approval received
        run: |
          echo "Manual approval received for mainnet deployment"
          echo "Network: ${{ inputs.network }}"
          echo "Initiated by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"

  deploy:
    name: Deploy to ${{ inputs.network }}
    needs: approval
    runs-on: ubuntu-latest
    environment: mainnet
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Create .env file
        run: |
          echo "ALCHEMY_API_KEY=${{ secrets.MAINNET_ALCHEMY_API_KEY }}" >> .env
          echo "DEPLOYER_PRIVATE_KEY=${{ secrets.MAINNET_DEPLOYER_PRIVATE_KEY }}" >> .env

      - name: Check deployer balance
        run: |
          uv run python -c "
          from web3 import Web3
          import os
          import json

          with open('config/networks.json') as f:
              networks = json.load(f)['networks']

          network = '${{ inputs.network }}'
          rpc_url = networks[network]['rpc_url'].replace('\${ALCHEMY_API_KEY}', os.getenv('ALCHEMY_API_KEY', ''))

          w3 = Web3(Web3.HTTPProvider(rpc_url))

          from eth_account import Account
          account = Account.from_key(os.getenv('DEPLOYER_PRIVATE_KEY'))
          balance = w3.eth.get_balance(account.address)
          balance_eth = w3.from_wei(balance, 'ether')

          print(f'Deployer address: {account.address}')
          print(f'Balance: {balance_eth} ETH')

          min_balance = 0.1  # Minimum ETH required
          if balance_eth < min_balance:
              raise Exception(f'Insufficient balance. Need at least {min_balance} ETH')
          "
        env:
          ALCHEMY_API_KEY: ${{ secrets.MAINNET_ALCHEMY_API_KEY }}
          DEPLOYER_PRIVATE_KEY: ${{ secrets.MAINNET_DEPLOYER_PRIVATE_KEY }}

      - name: Deploy contract
        id: deploy
        run: |
          uv run python scripts/deploy_simple.py ${{ inputs.network }} 2>&1 | tee deploy_output.txt
          CONTRACT_ADDRESS=$(grep -oP 'Contract deployed at: \K0x[a-fA-F0-9]+' deploy_output.txt || echo "")
          echo "contract_address=$CONTRACT_ADDRESS" >> $GITHUB_OUTPUT
        env:
          ALCHEMY_API_KEY: ${{ secrets.MAINNET_ALCHEMY_API_KEY }}
          DEPLOYER_PRIVATE_KEY: ${{ secrets.MAINNET_DEPLOYER_PRIVATE_KEY }}

      - name: Verify deployment
        run: uv run python scripts/verify_deployment.py ${{ inputs.network }}
        env:
          ALCHEMY_API_KEY: ${{ secrets.MAINNET_ALCHEMY_API_KEY }}

      - name: Health check
        run: |
          uv run python scripts/health_check.py ${{ inputs.network }} json > health.json
          cat health.json
        env:
          ALCHEMY_API_KEY: ${{ secrets.MAINNET_ALCHEMY_API_KEY }}

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mainnet-deployment-${{ inputs.network }}-${{ github.run_number }}
          path: |
            deployments/
            health.json
            deploy_output.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: mainnet-${{ inputs.network }}-v${{ github.run_number }}
          name: Mainnet Deployment - ${{ inputs.network }}
          body: |
            ## Mainnet Deployment

            **Network:** ${{ inputs.network }}
            **Contract Address:** ${{ steps.deploy.outputs.contract_address }}
            **Deployed by:** ${{ github.actor }}
            **Commit:** ${{ github.sha }}
            **Timestamp:** ${{ github.event.head_commit.timestamp }}
          files: |
            deployments/*
            health.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify on Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,action,workflow
          text: |
            :rocket: MAINNET DEPLOYMENT
            Network: ${{ inputs.network }}
            Contract: ${{ steps.deploy.outputs.contract_address }}
            Status: ${{ job.status }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true

  verify-explorer:
    name: Verify on Block Explorer
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Download deployment artifacts
        uses: actions/download-artifact@v4
        with:
          name: mainnet-deployment-${{ inputs.network }}-${{ github.run_number }}

      - name: Verify on explorer
        run: uv run python scripts/verify_on_explorer.py ${{ inputs.network }}
        env:
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          POLYGONSCAN_API_KEY: ${{ secrets.POLYGONSCAN_API_KEY }}
          ARBISCAN_API_KEY: ${{ secrets.ARBISCAN_API_KEY }}
          OPTIMISTIC_ETHERSCAN_API_KEY: ${{ secrets.OPTIMISTIC_ETHERSCAN_API_KEY }}
